{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        #map {
            height: 70vh;
            min-height: 500px;
        }
        .adboard-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .adboard-item:hover {
            background-color: #f3f4f6;
        }
        .adboard-item.active {
            background-color: #3b82f6;
            color: white;
        }
        .adboard-item.active h3,
        .adboard-item.active p,
        .adboard-item.active span {
            color: white !important;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">{{ page_title }}</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –Ω–æ—Å–∏—Ç–µ–ª–µ–π –≤ –≥–æ—Ä–æ–¥–µ –°–ª–∞–≤–≥–æ—Ä–æ–¥. 
            –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ—Å–∏—Ç–µ–ª—å –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
        </p>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-4">
        <div class="flex flex-wrap gap-2 items-center">
            <span class="font-semibold text-gray-700">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π:</span>
            <button id="zoom-to-all" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                üìç –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏
            </button>
            <button id="reset-center" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                üèôÔ∏è –¶–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- –ü–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ —Å–ø–∏—Å–∫–æ–º -->
        <div class="lg:col-span-1 bg-white rounded-lg shadow-md p-4">
            <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
            <div class="mb-4">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–¥—Ä–µ—Å—É..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã –Ω–æ—Å–∏—Ç–µ–ª–µ–π</option>
                    <option value="billboard">–ë–∏–ª–±–æ—Ä–¥—ã</option>
                    <option value="led_screen">LED-—ç–∫—Ä–∞–Ω—ã</option>
                    <option value="prismatron">–ü—Ä–∏–∑–º–∞—Ç—Ä–æ–Ω—ã</option>
                    <option value="citylight">–°–∏—Ç–∏–ª–∞–π—Ç—ã</option>
                    <option value="pillar">–°—Ç–æ–ª–±—ã</option>
                </select>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –Ω–æ—Å–∏—Ç–µ–ª–µ–π -->
            <div id="adboards-list" class="space-y-3 max-h-96 overflow-y-auto">
                {% for adboard in adboards %}
                <div class="adboard-item p-3 border border-gray-200 rounded-md" 
                     data-id="{{ adboard.id }}"
                     data-type="{{ adboard.ad_type }}"
                     data-lat="{{ adboard.lat }}"
                     data-lon="{{ adboard.lon }}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ adboard.title }}</h3>
                            <p class="text-sm text-gray-600">{{ adboard.address }}</p>
                            <span class="inline-block mt-1 px-2 py-1 text-xs rounded 
                                {% if adboard.ad_type == 'billboard' %}bg-blue-100 text-blue-800
                                {% elif adboard.ad_type == 'led_screen' %}bg-green-100 text-green-800
                                {% elif adboard.ad_type == 'prismatron' %}bg-purple-100 text-purple-800
                                {% elif adboard.ad_type == 'citylight' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ adboard.get_ad_type_display }}
                            </span>
                        </div>
                        {% if adboard.price %}
                        <div class="text-right">
                            <span class="text-lg font-bold text-orange-600">{{ adboard.price }} ‚ÇΩ</span>
                            <div class="text-xs text-gray-500">–≤ –º–µ—Å—è—Ü</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-gray-500 py-4">
                    –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –Ω–æ—Å–∏—Ç–µ–ª–µ–π
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–∞ –∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="lg:col-span-3">
            <div class="grid grid-cols-1 gap-6">
                <!-- –ö–∞—Ä—Ç–∞ -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div id="map"></div>
                </div>
                
                <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ—Å–∏—Ç–µ–ª—è) -->
                <div id="adboard-details" class="bg-white rounded-lg shadow-md p-6 hidden">
                    <div id="details-content">
                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- –í –±–ª–æ–∫–µ extra_js –ó–ê–ú–ï–ù–ò–¢–ï –≤–µ—Å—å JavaScript –∫–æ–¥ –Ω–∞ —ç—Ç–æ—Ç: -->
{% block extra_js %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=b0f7ece5-e9cd-48b8-8b89-1de9552b1f4d&lang=ru_RU" type="text/javascript"></script>
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let mapInstance = null;
    let allPlacemarks = {};
    let adboardItems = null;

    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –°–ª–∞–≤–≥–æ—Ä–æ–¥–∞ –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
    const SLAVGOROD_CENTER = [53.00, 78.65];

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON
    const adboardsData = JSON.parse('{{ adboards_json|escapejs }}');
    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–æ—Å–∏—Ç–µ–ª–µ–π:', adboardsData.length);
    adboardsData.forEach(adboard => {
        console.log('–ù–æ—Å–∏—Ç–µ–ª—å:', adboard.title, '–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', adboard.lat, adboard.lon);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –º–µ—Ç–∫–∏ –ø–æ —Ç–∏–ø—É
    function getPlacemarkColor(adType) {
        const colors = {
            'billboard': '#3b82f6',   // blue
            'led_screen': '#10b981',  // green
            'prismatron': '#8b5cf6',  // purple
            'citylight': '#f59e0b',   // yellow
            'pillar': '#6b7280'       // gray
        };
        return colors[adType] || '#3b82f6';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –∫–æ –≤—Å–µ–º –º–µ—Ç–∫–∞–º
    function zoomToAllPlacemarks() {
        if (!mapInstance || Object.keys(allPlacemarks).length === 0) {
            alert('–ù–µ—Ç –º–µ—Ç–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            return;
        }
        
        mapInstance.setBounds(mapInstance.geoObjects.getBounds(), {
            checkZoomRange: true,
            zoomMargin: 50
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞
    function resetToCityCenter() {
        if (mapInstance) {
            mapInstance.setCenter(SLAVGOROD_CENTER, 13);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –Ω–æ—Å–∏—Ç–µ–ª—è
    function selectAdboard(adboardId) {
        const adboard = adboardsData.find(a => a.id === adboardId);
        if (!adboard) return;

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç–∫–µ
        const placemark = allPlacemarks[adboardId];
        if (placemark) {
            mapInstance.setCenter([adboard.lat, adboard.lon], 16);
            placemark.balloon.open();
        }

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
        if (adboardItems) {
            adboardItems.forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.id) === adboardId) {
                    item.classList.add('active');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        showAdboardDetails(adboard);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function showAdboardDetails(adboard) {
        const detailsContainer = document.getElementById('adboard-details');
        const detailsContent = document.getElementById('details-content');
        
        let photoHtml = '';
        if (adboard.photo) {
            photoHtml = `
                <div class="mb-4">
                    <img src="${adboard.photo}" alt="${adboard.title}" 
                         class="w-full h-64 object-cover rounded-lg shadow-md">
                </div>
            `;
        }

        let priceHtml = '';
        if (adboard.price) {
            priceHtml = `
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                    <div class="text-2xl font-bold text-orange-600">${adboard.price} ‚ÇΩ</div>
                    <div class="text-orange-700">–≤ –º–µ—Å—è—Ü</div>
                </div>
            `;
        }

        detailsContent.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${adboard.title}</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">–ê–¥—Ä–µ—Å:</h3>
                            <p class="text-gray-600">${adboard.address}</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">–¢–∏–ø –Ω–æ—Å–∏—Ç–µ–ª—è:</h3>
                            <span class="inline-block px-3 py-1 rounded-full 
                                ${adboard.ad_type === 'billboard' ? 'bg-blue-100 text-blue-800' :
                                  adboard.ad_type === 'led_screen' ? 'bg-green-100 text-green-800' :
                                  adboard.ad_type === 'prismatron' ? 'bg-purple-100 text-purple-800' :
                                  adboard.ad_type === 'citylight' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-gray-100 text-gray-800'}">
                                ${adboard.get_ad_type_display}
                            </span>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</h3>
                            <p class="text-gray-600">${adboard.lat}, ${adboard.lon}</p>
                        </div>
                        
                        ${adboard.description ? `
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ:</h3>
                            <p class="text-gray-600 whitespace-pre-line">${adboard.description}</p>
                        </div>
                        ` : ''}
                        
                        ${adboard.rental_terms ? `
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">–£—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã:</h3>
                            <p class="text-gray-600 whitespace-pre-line">${adboard.rental_terms}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="lg:col-span-1">
                    ${priceHtml}
                    ${photoHtml}
                    
                    ${adboard.contact_info ? `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
                        <p class="text-gray-600 whitespace-pre-line">${adboard.contact_info}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        detailsContainer.classList.remove('hidden');
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –∏ –º–µ—Ç–æ–∫
    function filterAdboards() {
        const searchText = document.getElementById('search-input').value.toLowerCase();
        const filterType = document.getElementById('type-filter').value;

        adboardItems.forEach(item => {
            const title = item.querySelector('h3').textContent.toLowerCase();
            const address = item.querySelector('p').textContent.toLowerCase();
            const type = item.dataset.type;

            const matchesSearch = title.includes(searchText) || address.includes(searchText);
            const matchesType = !filterType || type === filterType;

            if (matchesSearch && matchesType) {
                item.style.display = 'block';
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
                const adboardId = parseInt(item.dataset.id);
                if (allPlacemarks[adboardId]) {
                    allPlacemarks[adboardId].options.set('visible', true);
                }
            } else {
                item.style.display = 'none';
                // –°–∫—Ä—ã–≤–∞–µ–º –º–µ—Ç–∫—É —Å –∫–∞—Ä—Ç—ã
                const adboardId = parseInt(item.dataset.id);
                if (allPlacemarks[adboardId]) {
                    allPlacemarks[adboardId].options.set('visible', false);
                }
            }
        });
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
    function initializeMap() {
        try {
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
            ymaps.ready(function() {
                mapInstance = new ymaps.Map('map', {
                    center: SLAVGOROD_CENTER,
                    zoom: 13,
                    controls: ['zoomControl', 'fullscreenControl']
                });

                console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');

                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏
                if (adboardsData.length > 0) {
                    adboardsData.forEach(adboard => {
                        const placemark = new ymaps.Placemark(
                            [adboard.lat, adboard.lon],
                            {
                                balloonContentHeader: adboard.title,
                                balloonContentBody: `
                                    <div class="p-2 max-w-sm">
                                        <p class="text-gray-600 mb-2">${adboard.address}</p>
                                        <p class="text-sm mb-2"><strong>–¢–∏–ø:</strong> ${adboard.get_ad_type_display}</p>
                                        <p class="text-sm mb-2"><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${adboard.lat}, ${adboard.lon}</p>
                                        ${adboard.price ? `<p class="text-lg font-bold text-orange-600 mb-2">${adboard.price} ‚ÇΩ/–º–µ—Å—è—Ü</p>` : ''}
                                        <button class="select-adboard w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition" data-id="${adboard.id}">
                                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        </button>
                                    </div>
                                `,
                                hintContent: adboard.title
                            },
                            {
                                preset: 'islands#dotIcon',
                                iconColor: getPlacemarkColor(adboard.ad_type)
                            }
                        );

                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –º–µ—Ç–∫—É
                        placemark.events.add('click', function() {
                            selectAdboard(adboard.id);
                        });

                        mapInstance.geoObjects.add(placemark);
                        allPlacemarks[adboard.id] = placemark;
                    });

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–±–ª–∏–∂–∞–µ–º—Å—è –∫–æ –≤—Å–µ–º –º–µ—Ç–∫–∞–º
                    setTimeout(() => {
                        if (Object.keys(allPlacemarks).length > 0) {
                            zoomToAllPlacemarks();
                        }
                    }, 1000);
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞
                adboardItems = document.querySelectorAll('.adboard-item');
                adboardItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const adboardId = parseInt(this.dataset.id);
                        selectAdboard(adboardId);
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π
                document.getElementById('zoom-to-all').addEventListener('click', zoomToAllPlacemarks);
                document.getElementById('reset-center').addEventListener('click', resetToCityCenter);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –±–∞–ª—É–Ω–∞—Ö
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('select-adboard')) {
                        const adboardId = parseInt(e.target.getAttribute('data-id'));
                        selectAdboard(adboardId);
                    }
                });

                // –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                document.getElementById('search-input').addEventListener('input', filterAdboards);
                document.getElementById('type-filter').addEventListener('change', filterAdboards);

            });

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            document.getElementById('map').innerHTML = `
                <div class="text-center p-8 text-red-600">
                    <h3 class="text-lg font-bold">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
    });
</script>
{% endblock %}